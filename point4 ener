private void updateCertificateBasedOnAddressAndPropertyDetails(
        EpcEnergyCertificate certificate,
        ObjectDeterminationByAddressResponse response,
        String transactionID
) {
    SearchResult searchResult = response.getSearchResult();

    List<PropertyDetails> propertyDetails = searchResult.getPropertyDetails();
    List<PostalAddress> postalAddresses = searchResult.getPostalAddress();

    boolean propertyDetailsEmpty = propertyDetails == null || propertyDetails.isEmpty();
    boolean hasVerifiedAddress = postalAddresses != null &&
            postalAddresses.stream().anyMatch(addr -> ValidationStateEnum.VERIFIED.equals(addr.getValidationState()));

    // --- CASE 4a ---
    if (propertyDetailsEmpty && hasVerifiedAddress) {
        for (PostalAddress verifiedAddr : postalAddresses) {
            if (ValidationStateEnum.VERIFIED.equals(verifiedAddr.getValidationState())) {
                EpcAddress validatedAddress = new EpcAddress();
                validatedAddress.setStreet(verifiedAddr.getStreet());
                validatedAddress.setHouseNumber(verifiedAddr.getHouseNumber());
                validatedAddress.setZipCode(verifiedAddr.getZipCode());
                validatedAddress.setCity(verifiedAddr.getCity());
                validatedAddress.setCountryISOCode(verifiedAddr.getCountryISOCode());
                validatedAddress.setAddressSource(String.valueOf(AddressSourceEnum.PD_VALIDATED));
                validatedAddress.setEnergyCertificate(certificate);
                certificate.getAddressList().add(validatedAddress);
            }
        }
        blackBoardService.updateValidationStatus(List.of(certificate.getEpcUUID()), "SUCCESS",
                "Empty property details; verified address added: txnid=" + transactionID);

    // --- CASE 4b ---
    } else if (propertyDetailsEmpty && !hasVerifiedAddress) {
        String testPropertyId = "01pLNneGjP5tsoa119M0"; // example/test propertyId
        List<EpcProperty> properties = epcPropertyRepository.findByPropertyId(testPropertyId);

        if (properties != null && !properties.isEmpty()) {
            EpcProperty property = properties.get(0);
            if (!certificate.getPropertyIdList().contains(property)) {
                certificate.getPropertyIdList().add(property);
            }
            if (!property.getEnergyCertificateList().contains(certificate)) {
                property.getEnergyCertificateList().add(certificate);
            }
            epcPropertyRepository.save(property);
            blackBoardService.updateValidationStatus(List.of(certificate.getEpcUUID()), "SUCCESS",
                    "Empty property details; only propertyId " + testPropertyId + " linked: txnid=" + transactionID);
        } else {
            // --- CASE 4c ---
            blackBoardService.updateValidationStatus(List.of(certificate.getEpcUUID()), "SUCCESS",
                    "Empty property details; no verified address, no propertyId linked: txnid=" + transactionID);
        }

    // Default: CASE propertyDetails present
    } else if (propertyDetails != null && !propertyDetails.isEmpty()) {
        boolean isVerified = propertyDetails.stream()
                .anyMatch(addr -> ValidationStateEnum.VERIFIED.equals(addr.getRealEstateAddress().getValidationState()) ||
                        ValidationStateEnum.CORRECTED.equals(addr.getRealEstateAddress().getValidationState()) ||
                        ValidationStateEnum.NORMALIZED.equals(addr.getRealEstateAddress().getValidationState()));

        boolean isNotVerified = propertyDetails.stream()
                .anyMatch(addr -> ValidationStateEnum.NOT_UNIQUE.equals(addr.getRealEstateAddress().getValidationState()) ||
                        ValidationStateEnum.NOT_FOUND.equals(addr.getRealEstateAddress().getValidationState()));

        if (isVerified) {
            updateValidationAddressAndProperties(certificate, response);
            blackBoardService.updateBlackBoard(List.of(certificate.getEpcUUID()), OnlineEnquiryStatus.UPDATED.getStatusName());
            blackBoardService.updateValidationStatus(List.of(certificate.getEpcUUID()), "SUCCESS", "Address verified = txnid " + transactionID);
        } else if (isNotVerified) {
            linkPropertiesToCertificate(certificate, response);
            blackBoardService.updateValidationStatus(List.of(certificate.getEpcUUID()), "SUCCESS",
                    "Address not validated: ODP address state txnid=" + transactionID);
        }
    }
}
